<!DOCTYPE html>

<html>
<head>
	<title>Tic Tac Toe</title>
	<style>
		html{
			background: #D6E7FF;
			font: 14px "Helvetica Neue", Helvetica, Arial, Verdana, sans-serif;
		}
		body{
			width: 25em;
			background: white;
			border: 0.3em solid #222;
			border-radius: 1em;
			padding: 1em;
			text-align: center;
			margin: 5em auto 0 auto;
		}
		h1{
			margin: 0.2em 0;
		}
		a.action{
			color: blue;
			text-decoration: underline;
			cursor: pointer;
		}
		a.action:active{
			color: red;
		}
		#board{
			width: 25em;
			height: 25em;
			border-collapse: collapse;
		}
		#board>tbody>tr>td{
			border: 0.5em solid transparent;
		}
		#board>tbody>tr>td:not(.chosen){
			cursor: pointer;
		}
		#board>tbody>tr:nth-last-child(n+2)>td{
			border-bottom-color: black;
		}
		#board>tbody>tr>td:nth-last-child(n+2){
			border-right-color: black
		}
		#board>tbody>tr>td.x{
			background: #798CFF;
		}
		#board>tbody>tr>td.o{
			background: #FF7C76;
		}
	</style>
</head>

<body>
<h1>Tic Tac Toe</h1>
<p>Pick a square to start playing, or <a class="action">let me start</a>.</p>
<table id="board" border=0 cellspacing=0 cellpadding=0>
	<tr>
		<td></td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td></td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td></td>
		<td></td>
		<td></td>
	</tr>
</table>
<script>
if (!('bind' in Function.prototype)) {
	Function.prototype.bind = function(context){
		var fn = this;
		return function(){
			return fn.apply(context, arguments);
		}
	}
}
function Board(board){
	if (board) {
		this.data = board.data.map(function(row){ return row.map(function(cell){ return { player: cell.player } }); });
	}
}
Board.prototype.get = function(x, y){
	if (x in this.data && y in this.data[x]){
		return this.data[x][y].player;
	}
};
Board.prototype.play = function(x, y, player){
	var position = this.data[x][y].player = player;
};

function ViewBoard(el, callback){
	this.data = [];
	this.callback = callback;
	Array.prototype.forEach.call(el.tBodies[0].rows, function(row, x){
		var cells = [];
		this.data.push(cells);
		Array.prototype.forEach.call(row.cells, function(cell, y){
			var cellData = { player: 0, element: cell };
			cells.push(cellData);
			cell.addEventListener('click', function(){
				if (cellData.player === 0) {
					this.callback({ x: x, y: y, cell: cellData });
				}
			}.bind(this));
		}.bind(this));
	}.bind(this));
}
ViewBoard.prototype = new Board;
ViewBoard.prototype.ownPlayer = 'o';
ViewBoard.prototype.play = function(x, y, player){
	var position = this.data[x][y], win;
	position.player = player;
	position.element.className = 'chosen ' + (this.ownPlayer === 'o' ? (player > 0 ? 'o' : 'x') : (player > 0 ? 'x' : 'o'));
	if((win = checkWin(this)) !== null){
		console.log(win === 1 ? 'I won' : win === -1 ? 'you won' : 'draw');
		setTimeout(function(){
			board.reset();
		}, 2000);
	}
	return win;
};
ViewBoard.prototype.reset = function(){
	this.data.forEach(function(row){
		row.forEach(function(cell){
			cell.player = 0;
			cell.element.className = '';
		});
	});
};


function Game(board){
	this.board = board;
};
function checkWin(board){
	var count, squaresLeft = 9;
	
	// Rows
	for (var row = 0; row <= 2; row++) {
		count = { '1': 0, '-1': 0, '0': 0 }
		for (var col = 0; col <= 2; col++) {
			count[board.get(row, col)]++;
			if (board.get(row, col)) {
				squaresLeft--;
			}
		}
		if (count['1'] === 3) {
			return 1;
		} else if (count['-1'] === 3){
			return -1;
		}
	}
	
	// Columns
	for (var col = 0; col <= 2; col++) {
		count = { '1': 0, '-1': 0, '0': 0 }
		for (var row = 0; row <= 2; row++) {
			count[board.get(row, col)]++;
		}
		if (count['1'] === 3) {
			return 1;
		} else if (count['-1'] === 3){
			return -1;
		}
	}
	
	// Diagonal
	count = { '1': 0, '-1': 0, '0': 0 }
	for (var i = 0; i <= 2; i++) {
		count[board.get(i, i)]++;
	}
	if (count['1'] === 3) {
		return 1;
	} else if (count['-1'] === 3){
		return -1;
	}
	
	// Antidiagonal
	count = { '1': 0, '-1': 0, '0': 0 }
	for (var i = 0; i <= 2; i++) {
		count[board.get(i, 2-i)]++;
	}
	if (count['1'] === 3) {
		return 1;
	} else if (count['-1'] === 3){
		return -1;
	}
	return squaresLeft ? null : 0;
}

function ppBoard(board){
	return board.data.map(function(row){ return row.map(function(cell){ return { '1': 'o', '-1': 'x', '0': ' '}[cell.player]; }).join(''); });
}

function rankBoard(board, opponentsTurn){
	var outcomes = [], testBoard, winner;
	for (var row = 0; row <= 2; row++) {
		for (var col = 0; col <= 2; col++) {
			if (board.get(row, col) == 0){
				testBoard = new Board(board);
				testBoard.play(row, col, opponentsTurn ? -1 : 1);
				winner = checkWin(testBoard);
				if (winner != null) {
					outcomes.push({ move: [row, col], board: ppBoard(testBoard), score: (opponentsTurn ? -1 : 1) * winner });
				} else {
					var nextMove = rankBoard(testBoard, !opponentsTurn);
					outcomes.push({ move: [row, col], score: -nextMoves.score * 0.9, board: ppBoard(testBoard), children: nextMoves, player: opponentsTurn ? 'x' : 'o' });
				}
			}
		}
	}
	return outcomes.sort(function(a, b){ return a.score < b.score ? 1 : a.score > b.score ? -1 : 0; })[0];
}


var board = new ViewBoard(document.getElementById('board'), function(move){
	var win;
	if ((win = board.play(move.x, move.y, -1)) === null) {
		setTimeout(function(){
			board.play.apply(board, rankBoard(board)[0].move.concat(1));
		});
	}
});
var game = new Game(board);
</script>
</body>
</html>
